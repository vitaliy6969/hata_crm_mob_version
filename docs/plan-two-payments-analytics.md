# План: два окремі платежі — передплата та основна сума, обидва в аналітиці

## Ідея

- **Передплата** — окремий платіж. Натискаємо «Оплачено» (передплата) → ця сума **відображається в аналітиці**.
- **Основна сума** — окремий платіж. Натискаємо «Підтвердити» (основна сума) → ця сума **теж відображається в аналітиці**.
- Усе вирішується на рівні БД: чи підтверджено передплату (`prepayment_paid`), чи підтверджено основну суму (`full_amount_paid`). Якщо так — відповідний платіж уже є в даних, просто в аналітиці його треба **враховувати**.
- В інтерфейсі залишаються **два** рядки з кнопками (без єдиного перемикача «Оплачено для аналітики»): передплата і основна сума; кожен після підтвердження сам з’являється в звітах.

---

## Логіка в аналітиці (БД + розрахунок)

У таблиці `bookings` вже є:

- `prepayment` — сума передплати  
- `prepayment_paid` — чи підтверджено передплату  
- `total_price` — загальна сума  
- `full_amount_paid` — чи підтверджено основну суму  

**Сума, яка потрапляє в дохід по броні:**

- Якщо підтверджено тільки передплату: в дохід йде **prepayment**.
- Якщо підтверджено тільки основну суму: в дохід йде **(total_price − prepayment)** (щоб не рахувати передплату двічі).
- Якщо підтверджено обидва: в дохід йде **total_price** (або те саме як сума: prepayment + (total_price − prepayment)).

Тобто одна формула для однієї броні:

```text
paid_amount = (prepayment_paid ? prepayment : 0) + (full_amount_paid ? (total_price - prepayment) : 0)
```

Якщо `paid_amount = 0`, бронь в аналітику доходу не йде. Якщо > 0 — цю суму розподіляємо по ночах (ніч = день заїзду), як зараз: по місяцях і по квартирах.

---

## Що змінити в коді

### 1. Аналітика (backend)

**Файл:** [src/analytics-refresh.js](src/analytics-refresh.js)

- У запитах до `bookings` замість умови `full_amount_paid = true` брати броні, у яких **є хоча б один підтверджений платіж**:
  - `(prepayment_paid = true OR full_amount_paid = true)`  
  і додати в `SELECT` поля **prepayment, total_price, prepayment_paid, full_amount_paid**.
- Для кожної броні рахувати:
  - `paid_amount = (prepayment_paid ? prepayment : 0) + (full_amount_paid ? (total_price - prepayment) : 0)`  
  (у коді врахувати null/undefined і безпечно переводити в число).
- Якщо `paid_amount <= 0`, бронь пропускати.
- Далі як зараз: розподіл по ночах — `price_per_night = paid_amount / total_nights`, по кожному місяцю/періоду: `income += price_per_night * nights_in_period`.

Це застосувати в обох місцях: **computeMonthly** (підсумок по місяцях) і **computeByApartment** (по об’єктах).

### 2. Інтерфейс картки броні (frontend)

**Файл:** [public/index.html](public/index.html)

- **Прибрати** перемикач «Оплачено (враховується в аналітиці)» (рядок з `detPaidToggle` і `.toggle-switch`).
- **Залишити** два рядки:
  - «Передплата внесена:» + бейдж + кнопка «Підтвердити передплату».
  - «Основна сума сплачена:» + бейдж + кнопка «Підтвердити оплату».

Тобто лишаються тільки ці два окремі платежі; жодного третього елемента «для аналітики».

**Файл:** [public/js/app.js](public/js/app.js)

- Прибрати весь код, пов’язаний з **detPaidToggle** (встановлення `checked`, `onchange`, оновлення `full_amount_paid` через перемикач).
- Логіку «Основна сума сплачена» лишити тільки через кнопку «Підтвердити оплату» (PATCH `full_amount_paid: true`) і бейдж, як було до перемикача.
- Переконатися, що після натискання «Підтвердити передплату» або «Підтвердити оплату» оновлюються відповідні поля в об’єкті броні (щоб при повторному відкритті картки все відображалось коректно).

### 3. База даних

- Змін у схемі БД **не потрібно**: поля `prepayment`, `prepayment_paid`, `total_price`, `full_amount_paid` вже є. Вся логіка «чи підтверджено, чи проявилось в аналітиці» — це лише умови в запитах і формула `paid_amount` у скрипті аналітики.

---

## Підсумок

| Що | Дія |
|----|-----|
| Аналітика | Рахувати дохід по броні як суму двох платежів: підтверджена передплата + підтверджена основна сума (total_price − prepayment). Брати в розрахунок броні, де prepayment_paid OR full_amount_paid. Розподіл по ночах лишається. |
| Картка броні | Один перемикач прибрати. Залишити два рядки з кнопками «Підтвердити передплату» та «Підтвердити оплату» — кожен сам визначає, чи відповідний платіж «проявиться» в аналітиці через БД. |
| БД | Без змін. |

Після внесення змін достатньо перезапустити скрипт оновлення кешу аналітики (або натиснути «Оновити аналітику»), щоб у звітах було видно обидва типи платежів згідно з підтвердженнями в картці.
